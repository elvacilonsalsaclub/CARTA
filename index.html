<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>El Vacilón — Sistema</title>

  <!-- SheetJS para leer XLSX desde el navegador -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{--accent:#ff0066;--glass:rgba(0,0,0,0.55)}
    html,body{height:100%;margin:0;font-family:Inter, Arial, sans-serif;background:#0b1020;color:#fff}
    /* Video fondo */
    .bg-video{position:fixed;inset:0;z-index:-10;overflow:hidden}
    .bg-video video{width:100%;height:100%;object-fit:cover;filter:brightness(0.45)}
    /* Center login */
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .card{background:var(--glass);padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.6);max-width:420px;width:92%}
    .logo{display:block;margin:0 auto 12px;max-width:260px;width:60%}
    input,select,button{font-size:15px}
    input[type="text"],input[type="password"],select{width:100%;padding:10px;border-radius:8px;border:none;margin:6px 0}
    button{cursor:pointer;padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12)}
    .small{font-size:13px;color:#ddd}
    /* App layout */
    #app{display:none;padding:18px;min-height:100vh;box-sizing:border-box}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
    .panel{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
    .tables-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .table-card{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center}
    .session-list{max-height:160px;overflow:auto;margin-top:6px;text-align:left;font-size:13px}
    .products-table, .invoice-table{width:100%;border-collapse:collapse;background:#fff;color:#000;border-radius:8px;overflow:hidden}
    .products-table th, .products-table td, .invoice-table th, .invoice-table td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
    footer{position:fixed;left:0;right:0;bottom:0;padding:8px;text-align:center;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.6));font-size:13px;color:#ccc}
    /* modal selection day prices */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:50}
    .modal-box{background:#0f1724;padding:18px;border-radius:10px;max-width:420px;width:90%}
    label.radio{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);margin:8px 0;cursor:pointer}
    .muted{color:#bbb;font-size:13px}
    /* responsive */
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .tables-grid{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>
<body>
  <!-- Video de fondo -->
  <div class="bg-video" aria-hidden="true">
    <video autoplay muted loop playsinline>
      <source src="video_elvacilon1.mp4" type="video/mp4">
    </video>
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="center">
    <div class="card">
      <img src="logo_elvacilon1.png" alt="Logo El Vacilón" class="logo">
      <h2 style="text-align:center;margin:6px 0">Sistema — El Vacilón</h2>
      <div class="small" style="text-align:center;margin-bottom:10px">Ingresa con tu usuario</div>

      <input id="inputUser" type="text" placeholder="Usuario (ej: alex)">
      <input id="inputPass" type="password" placeholder="Contraseña">

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnLogin">Ingresar</button>
        <button class="ghost" id="btnDemo">Demo</button>
      </div>

      <div style="margin-top:10px" class="small">
        Usuarios: alex/123, santiago/456, mesero3/3, mesero4/4, cajera/123456, admin/123456789
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <header>
      <div>
        <h1 style="margin:0">El Vacilón — Panel</h1>
        <div class="small" id="userInfo">Usuario: —</div>
      </div>
      <div class="actions">
        <button id="btnLogout" class="ghost">Cerrar sesión</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: mesas y comanda -->
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Mesas</h3>
          <div class="small">28 mesas — abre nueva visita al presionar "Abrir"</div>
        </div>

        <div style="margin-top:10px" class="tables-grid" id="tablesGrid"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

        <h3 style="margin-top:6px">Comanda / Factura</h3>
        <div style="overflow:auto;margin-top:8px">
          <table class="products-table" id="cartTable">
            <thead>
              <tr>
                <th style="width:60px">#</th>
                <th>Producto</th>
                <th style="width:90px">Cant.</th>
                <th style="width:120px">Precio</th>
                <th style="width:120px">Total</th>
                <th style="width:80px">Acción</th>
              </tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>

        <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
          <button id="btnAddLine" class="ghost">Agregar línea</button>
          <label class="small" style="margin-left:auto">Propina: <input id="chkTip" type="checkbox" checked style="margin-left:6px"> <input id="tipPercent" type="number" value="10" style="width:60px;margin-left:6px;padding:6px;border-radius:6px;border:none;color:#000"> %</label>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="small">Subtotal / descuentos aplicables desde la cajera</div>
          <div><strong id="grandTotalText">Total: $0</strong></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnCloseAccount">Cerrar cuenta</button>
          <button id="btnPrint" class="ghost">Imprimir factura</button>
          <button id="btnClear" class="ghost">Limpiar comanda</button>
        </div>
      </section>

      <!-- RIGHT: productos y admin -->
      <aside class="panel">
        <h3 style="margin:0">Productos cargados</h3>
        <div class="small" style="margin-top:6px">Consecutivo numérico automático. Selecciona día de precios al iniciar.</div>

        <div id="productsCount" style="margin-top:10px" class="small">Productos: 0</div>
        <div id="productsList" style="margin-top:10px;max-height:380px;overflow:auto"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

        <div id="adminPanel" class="hidden">
          <h4 style="margin:0">Panel Administrador</h4>
          <div class="small" style="margin-top:8px">Controles adicionales: editar precios, reporte sencillo</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="btnExportCSV" class="ghost">Exportar productos CSV</button>
            <button id="btnReport" class="ghost">Generar reporte</button>
          </div>
          <div id="reportArea" style="margin-top:10px" class="small"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal: elección día de precios -->
  <div id="modalDay" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-box">
      <h3 style="margin:0 0 6px 0">Seleccione día de precios</h3>
      <p class="muted">El sistema cargará el archivo Excel correspondiente desde la misma carpeta.</p>

      <label class="radio"><input type="radio" name="dayPrice" value="JVS.xlsx" checked> Día Normal — JVS (precios regulares)</label>
      <label class="radio"><input type="radio" name="dayPrice" value="DOMINGO.xlsx"> Domingo — DOMINGO (precios económicos)</label>

      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button id="btnLoadPrices">Cargar precios</button>
      </div>
    </div>
  </div>

  <!-- Plantilla factura para impresión (oculta) -->
  <div id="invoiceTemplate" class="hidden">
    <!-- se construye dinámicamente -->
  </div>

  <footer>
    Discoteca El Vacilón — Dirección: carrera 23a # 7A - 15 — Celular: 3147159066 / 3136188889 — Instagram: @elvacilonclub
  </footer>

<script>
/* -------------------------
   Configuración inicial
   ------------------------- */
const USERS = {
  "alex":"123", "santiago":"456", "mesero3":"3", "mesero4":"4", "cajera":"123456", "admin":"123456789"
};
const USER_ROLES = {
  "alex":"Mesero Alex", "santiago":"Mesero Santiago", "mesero3":"Mesero 3", "mesero4":"Mesero 4",
  "cajera":"Cajera", "admin":"Administrador"
};

let currentUser = null;
let products = []; // {id:number, nombre:string, precio:number}
let tables = [];
const TABLE_COUNT = 28;

/* -------------------------
   Utilidades
   ------------------------- */
function $(id){return document.getElementById(id)}
function money(n){ return '$' + Number(Math.round(n)).toLocaleString(); }
function parseNumber(v){ if(v===undefined||v===null) return 0; return Number(String(v).replace(/[^0-9\.\-]/g,'')) || 0; }

/* -------------------------
   Login
   ------------------------- */
$('btnLogin').addEventListener('click', ()=>{
  const u = $('inputUser').value.trim().toLowerCase();
  const p = $('inputPass').value.trim();
  if(USERS[u] && USERS[u] === p){
    currentUser = u;
    $('loginScreen').classList.add('hidden');
    $('app').style.display = 'block';
    $('userInfo').innerText = `Usuario: ${USER_ROLES[u] || u} — Rol: ${ (u === 'admin')? 'Administrador' : (u==='cajera'?'Cajera':'Mesero') }`;
    if(u === 'admin') $('adminPanel').classList.remove('hidden');
    // mostrar modal para seleccionar día de precios
    showDayModal();
    initTables();
  } else {
    alert('Usuario o contraseña incorrectos');
  }
});
$('btnDemo').addEventListener('click', ()=>{ $('inputUser').value='alex'; $('inputPass').value='123'; $('btnLogin').click(); });

$('btnLogout').addEventListener('click', ()=>{ location.reload(); });

/* -------------------------
   Modal día de precios
   ------------------------- */
function showDayModal(){ $('modalDay').classList.remove('hidden'); }
function hideDayModal(){ $('modalDay').classList.add('hidden'); }

$('btnLoadPrices').addEventListener('click', async ()=>{
  // obtener radio seleccionado
  const radios = document.getElementsByName('dayPrice');
  let filename = 'JVS.xlsx';
  for(const r of radios) if(r.checked) filename = r.value;
  hideDayModal();
  try{
    await loadProductsFromExcel(filename);
    renderProductsList();
    alert('Productos cargados: ' + products.length + ' (archivo: ' + filename + ')');
  }catch(err){
    console.error(err);
    alert('Error cargando archivo. Asegúrate de que '+filename+' esté en la misma carpeta y sea accesible desde el servidor.');
  }
});

/* -------------------------
   Cargar XLSX vía fetch + SheetJS
   ------------------------- */
async function loadProductsFromExcel(filename){
  // fetch the file from same folder; when hosted on GitHub Pages it will be accessible.
  const res = await fetch(filename);
  if(!res.ok) throw new Error('No se pudo leer ' + filename + ' (HTTP ' + res.status + ')');
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab, {type:'array'});
  const first = wb.SheetNames[0];
  const sheet = wb.Sheets[first];
  // intentar columnas: producto / valor (cualquier mayúscula/minúscula)
  const json = XLSX.utils.sheet_to_json(sheet, {defval: ''});
  // map json rows --> producto / valor
  products = json.map((row, idx) => {
    // buscar key que contenga 'producto' o 'name'
    const keys = Object.keys(row);
    let nombre = '';
    let precio = 0;
    for(const k of keys){
      const kl = k.toString().toLowerCase();
      if(kl.includes('producto') || kl.includes('nombre') || kl.includes('product')) nombre = row[k];
      if(kl.includes('valor') || kl.includes('price') || kl.includes('precio') ) precio = row[k];
    }
    // si no encontró por clave, intentar por posición (col1,col2)
    if(!nombre && keys.length >= 1) nombre = row[keys[0]];
    if((!precio || precio===0) && keys.length >= 2) precio = row[keys[1]];
    return { id: idx+1, nombre: String(nombre).trim(), precio: parseNumber(precio) };
  }).filter(p => p.nombre); // quitar filas sin nombre
}

/* -------------------------
   Render productos (right panel)
   ------------------------- */
function renderProductsList(){
  $('productsList').innerHTML = '';
  $('productsCount').innerText = 'Productos: ' + products.length;
  const container = $('productsList');
  const ul = document.createElement('div');
  ul.style.display = 'grid';
  ul.style.gridTemplateColumns = '1fr';
  ul.style.gap = '6px';
  products.forEach(p => {
    const div = document.createElement('div');
    div.style.padding = '8px';
    div.style.borderRadius = '6px';
    div.style.background = 'rgba(255,255,255,0.02)';
    div.innerHTML = `<strong style="display:inline-block;width:34px;text-align:right;margin-right:8px">${p.id}.</strong> <span>${p.nombre}</span> <span style="float:right">${money(p.precio)}</span>`;
    ul.appendChild(div);
  });
  container.appendChild(ul);
}

/* -------------------------
   Mesas (left) - sesiones
   ------------------------- */
function initTables(){
  tables = Array.from({length: TABLE_COUNT}, (_,i) => ({ number: i+1, visits: 0, sessions: [] }));
  renderTables();
}
function renderTables(){
  const grid = $('tablesGrid'); grid.innerHTML = '';
  tables.forEach(t => {
    const card = document.createElement('div'); card.className = 'table-card';
    card.innerHTML = `<div style="font-weight:600">Mesa ${t.number}</div><div class="small">Visitas: ${t.visits}</div>`;
    const btn = document.createElement('button'); btn.style.marginTop='8px'; btn.style.width='100%'; btn.innerText='Abrir (nueva visita)';
    btn.addEventListener('click', ()=> openSession(t.number));
    card.appendChild(btn);

    // sessions summary
    const sCont = document.createElement('div'); sCont.className='session-list';
    t.sessions.slice().reverse().forEach(s => {
      const d = document.createElement('div'); d.style.padding='6px'; d.style.borderRadius='6px'; d.style.marginBottom='6px'; d.style.background='rgba(255,255,255,0.02)';
      d.innerHTML = `<div style="display:flex;justify-content:space-between"><div>Visita ${s.visitNumber}</div><div>${s.closed?'<span style="color:#ff6b6b">CERRADA</span>':'ABIERTA'}</div></div><div class="small">Mesero: ${USER_ROLES[s.waiter] || s.waiter}</div>`;
      const openBtn = document.createElement('button'); openBtn.className='ghost'; openBtn.style.marginTop='6px'; openBtn.innerText='Abrir panel';
      openBtn.addEventListener('click', ()=> openSessionPanel(t.number, s.id));
      d.appendChild(openBtn);
      sCont.appendChild(d);
    });

    card.appendChild(sCont);
    grid.appendChild(card);
  });
}

/* -------------------------
   Sesiones y comanda (cart)
   ------------------------- */
let currentSessionContext = null; // {tableNumber, sessionId}
function openSession(tableNumber){
  if(!currentUser){ alert('Inicia sesión'); return; }
  const t = tables.find(x=>x.number===tableNumber);
  t.visits += 1;
  const session = { id: 's_'+Math.random().toString(36).slice(2,9), visitNumber: t.visits, createdAt: new Date().toISOString(), items: [], waiter: currentUser, closed:false, tipPercent:10, tipApplied:true, discount:0 };
  t.sessions.push(session);
  saveStateToLocal();
  renderTables();
  openSessionPanel(tableNumber, session.id);
}

function openSessionPanel(tableNumber, sessionId){
  currentSessionContext = {tableNumber, sessionId};
  // if user opens a session, we'll show its items in the cart area
  renderCartFromCurrentSession();
  // scroll to cart
  window.scrollTo({top:0,behavior:'smooth'});
}

/* cart render */
function renderCartFromCurrentSession(){
  const tbody = $('cartBody'); tbody.innerHTML = '';
  if(!currentSessionContext) return;
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  // render items of session
  session.items.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="number" min="1" value="${it.productId}" style="width:60px" onchange="onProductNumberChange(this)"></td>
      <td class="prodName">${escapeHtml(it.name)}</td>
      <td><input type="number" min="1" value="${it.qty}" style="width:70px" onchange="onQtyChange(this)"></td>
      <td class="prodPrice">${money(it.price)}</td>
      <td class="prodTotal">${money(it.price * it.qty)}</td>
      <td><button class="ghost" onclick="removeLine(this)">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
  // if no items, add one empty row
  if(session.items.length === 0) addLineToSession();
  updateTotalsDisplay();
}

/* add line to current session (and UI) */
function addLineToSession(){
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  // push placeholder item (productId empty)
  session.items.push({ productId: '', name: '', price: 0, qty: 1 });
  saveStateToLocal();
  renderCartFromCurrentSession();
}

/* handlers used in inline onchange */
window.onProductNumberChange = function(inp){
  const val = parseInt(inp.value) || 0;
  const tr = inp.closest('tr');
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  const index = Array.from(tr.parentElement.children).indexOf(tr);
  const prod = products.find(p=>p.id === val);
  if(prod){
    session.items[index].productId = prod.id;
    session.items[index].name = prod.nombre;
    session.items[index].price = prod.precio;
    // set qty if empty
    if(!session.items[index].qty) session.items[index].qty = 1;
  } else {
    session.items[index].productId = '';
    session.items[index].name = '';
    session.items[index].price = 0;
  }
  saveStateToLocal();
  renderCartFromCurrentSession();
};

window.onQtyChange = function(inp){
  const qty = parseInt(inp.value) || 0;
  const tr = inp.closest('tr');
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  const index = Array.from(tr.parentElement.children).indexOf(tr);
  session.items[index].qty = qty;
  saveStateToLocal();
  renderCartFromCurrentSession();
};

function removeLine(btn){
  const tr = btn.closest('tr');
  const tbody = tr.parentElement;
  const idx = Array.from(tbody.children).indexOf(tr);
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  session.items.splice(idx,1);
  saveStateToLocal();
  renderCartFromCurrentSession();
}

/* btnAddLine */
$('btnAddLine').addEventListener('click', ()=>{
  if(!currentSessionContext){ alert('Abre primero una mesa/visita'); return; }
  addLineToSession();
});

/* clear comanda */
$('btnClear').addEventListener('click', ()=>{
  if(!currentSessionContext) return;
  if(!confirm('Limpiar comanda actual?')) return;
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  session.items = [];
  saveStateToLocal();
  renderCartFromCurrentSession();
});

/* tip controls */
$('chkTip').addEventListener('change', ()=>{
  if(!currentSessionContext) return;
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  session.tipApplied = $('chkTip').checked;
  saveStateToLocal();
  updateTotalsDisplay();
});
$('tipPercent').addEventListener('change', ()=>{
  if(!currentSessionContext) return;
  const v = parseFloat($('tipPercent').value) || 0;
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===session.id);
  // note: session may be undefined if closed; but we store tip in session when closing
  updateTotalsDisplay();
});

/* compute totals */
function computeCurrentTotals(){
  if(!currentSessionContext) return {subtotal:0, tip:0, total:0};
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  const subtotal = session.items.reduce((s,it)=> s + (parseNumber(it.price) * (parseInt(it.qty)||0)), 0);
  const tipPercent = parseFloat($('tipPercent').value) || 0;
  const tipApplied = $('chkTip').checked;
  const tip = tipApplied ? Math.round(subtotal * (tipPercent/100)) : 0;
  const total = subtotal + tip - (session.discount||0);
  return {subtotal, tip, total};
}
function updateTotalsDisplay(){
  const totals = computeCurrentTotals();
  $('grandTotalText').innerText = 'Total: ' + money(totals.total);
}

/* close account (mark session closed) */
$('btnCloseAccount').addEventListener('click', ()=>{
  if(!currentSessionContext) { alert('Abre primero una mesa/visita'); return; }
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  // calculate totals and mark closed
  const totals = computeCurrentTotals();
  session.closed = true;
  session.closedAt = new Date().toISOString();
  session.finalTotals = totals;
  saveStateToLocal();
  renderTables();
  alert('Cuenta cerrada. Total: ' + money(totals.total));
});

/* imprimir factura */
$('btnPrint').addEventListener('click', ()=>{
  if(!currentSessionContext) { alert('Abre primero una mesa/visita'); return; }
  const table = tables.find(t=>t.number===currentSessionContext.tableNumber);
  const session = table.sessions.find(s=>s.id===currentSessionContext.sessionId);
  // prepare invoice HTML
  const now = new Date();
  const fecha = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
  let itemsHtml = '';
  let subtotal = 0;
  session.items.forEach(it => {
    if(!it.name) return;
    const lineTotal = parseNumber(it.price) * (parseInt(it.qty)||0);
    subtotal += lineTotal;
    itemsHtml += `<tr><td style="padding:4px">${escapeHtml(it.productId)}</td><td style="padding:4px">${escapeHtml(it.name)}</td><td style="padding:4px;text-align:center">${escapeHtml(String(it.qty))}</td><td style="padding:4px;text-align:right">${money(lineTotal)}</td></tr>`;
  });
  const tipPercent = parseFloat($('tipPercent').value) || 0;
  const tipApplied = $('chkTip').checked;
  const tip = tipApplied ? Math.round(subtotal * (tipPercent/100)) : 0;
  const total = subtotal + tip - (session.discount||0);

  const invoiceHtml = `
  <div style="width:320px;font-family:Arial;color:#000;">
    <div style="text-align:center">
      <img src="logo_elvacilon1.png" style="max-width:120px"><h2 style="margin:6px 0">Discoteca El Vacilón</h2>
      <div style="font-size:13px">Dirección: carrera 23a # 7A - 15</div>
      <div style="font-size:13px">Celular: 3147159066 - 3136188889</div>
      <div style="font-size:13px">Instagram: @elvacilonclub</div>
      <div style="margin-top:8px;font-size:13px">Fecha y hora: ${escapeHtml(fecha)}</div>
      <hr style="margin:8px 0">
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:13px;">
      <thead>
        <tr><th style="text-align:left">#</th><th style="text-align:left">Producto</th><th style="text-align:center">Cant.</th><th style="text-align:right">Valor</th></tr>
      </thead>
      <tbody>
        ${itemsHtml}
      </tbody>
    </table>
    <hr style="margin:8px 0">
    <div style="display:flex;justify-content:space-between;font-size:14px"><div>Subtotal:</div><div>${money(subtotal)}</div></div>
    <div style="display:flex;justify-content:space-between;font-size:14px"><div>Propina (${tipPercent}%):</div><div>${money(tip)}</div></div>
    <div style="display:flex;justify-content:space-between;font-weight:700;font-size:16px"><div>Total:</div><div>${money(total)}</div></div>
    <hr style="margin:8px 0">
    <div style="text-align:center;font-weight:700">${escapeHtml('el Vacilón salsa club')}</div>
    <div style="text-align:center;font-size:12px;margin-top:6px">¡Gracias por preferirnos!</div>
  </div>
  `;

  const w = window.open('', '_blank', 'width=400,height=700');
  w.document.write('<html><head><title>Factura</title></head><body>');
  w.document.write(invoiceHtml);
  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  // delay print slightly so images load
  setTimeout(()=>{ w.print(); }, 600);
});

/* -------------------------
   Estado local simple (opcional)
   ------------------------- */
function saveStateToLocal(){
  try{
    const obj = { tables, products };
    localStorage.setItem('ev_state', JSON.stringify(obj));
  }catch(e){}
}
function loadStateFromLocal(){
  try{
    const raw = localStorage.getItem('ev_state');
    if(!raw) return false;
    const obj = JSON.parse(raw);
    if(obj.products) products = obj.products;
    if(obj.tables) tables = obj.tables;
    return true;
  }catch(e){ return false; }
}
loadStateFromLocal();

/* -------------------------
   Export / Admin functions
   ------------------------- */
$('btnExportCSV').addEventListener('click', ()=>{
  if(products.length===0){ alert('No hay productos'); return; }
  const rows = products.map(p => `${p.id},"${p.nombre.replace(/"/g,'""')}",${p.precio}`).join('\n');
  const blob = new Blob([rows], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'products_export.csv'; a.click(); URL.revokeObjectURL(url);
});

$('btnReport').addEventListener('click', ()=>{
  // simple report: ventas cerradas por mesero
  const closed = tables.flatMap(t=>t.sessions).filter(s=>s.closed);
  let total = 0;
  const byWaiter = {};
  closed.forEach(s=>{
    const val = (s.finalTotals && s.finalTotals.total) ? s.finalTotals.total : 0;
    total += val;
    const w = s.waiter || s.mesero || 'sin';
    byWaiter[w] = (byWaiter[w]||0) + val;
  });
  const lines = [`Total ventas (cerradas): ${money(total)}`].concat(Object.keys(byWaiter).map(k=>`${k}: ${money(byWaiter[k])}`)).join('<br>');
  $('reportArea').innerHTML = lines;
});

/* -------------------------
   Helpers: escaping
   ------------------------- */
function escapeHtml(str){
  if(!str && str!==0) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* -------------------------
   Init UI if products already loaded from local
   ------------------------- */
if(products && products.length > 0){
  renderProductsList();
  renderTables();
}

/* -------------------------
   Useful: try to auto-load default JVS.xlsx if available (optional)
   ------------------------- */
/* Uncomment if you want auto-load on page open (but we show modal by default):
(async ()=> {
  try { await loadProductsFromExcel('JVS.xlsx'); renderProductsList(); } catch(e){}
})(); */

</script>
</body>
</html>
